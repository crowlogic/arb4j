package arb.utensils;

import java.io.IOException;
import java.nio.file.*;
import java.util.stream.Stream;

/**
 * @see arb.documentation.BusinessSourceLicenseVersionOnePointOne for Â© terms
 */
public class LineCounter
{
  private static final String INDICATOR = "This file was automatically generated by SWIG";

  public static void main(String[] args) throws IOException
  {
    String sourceDir = args.length
                  > 0 ? args[0] : String.format("%s/git/arb4j", System.getProperty("user.home"));
    long   count     = countLines(sourceDir);
    System.out.format("Total Java lines (excluding SWIG files) in %s: %s\n", sourceDir, count);
  }

  protected static long countLines(String sourceDir) throws IOException
  {
    try ( var sourceFiles = recursivelyListFiles(sourceDir))
    {
      return sourceFiles.filter(LineCounter::shouldBeCounted)
                        .mapToLong(LineCounter::countLines)
                        .sum();
    }
  }

  protected static Stream<Path> recursivelyListFiles(String sourceDir) throws IOException
  {
    return Files.walk(Paths.get(sourceDir));
  }

  protected static long countLines(Path p)
  {
    try
    {
      return Files.lines(p).count();
    }
    catch (IOException e)
    {
      Utensils.throwOrWrap(e);
      return -1;
    }
  }

  protected static boolean shouldBeCounted(Path p)
  {
    try
    {
      return isJavaSourceFile(p) && isAutomaticallyGeneratedBySWIG(p);
    }
    catch (IOException e)
    {
      Utensils.throwOrWrap(e);
      return false;
    }
  }

  protected static boolean isJavaSourceFile(Path p)
  {
    return p.toString().endsWith(".java");
  }

  protected static boolean isAutomaticallyGeneratedBySWIG(Path p) throws IOException
  {
    return Files.lines(p).noneMatch(LineCounter::containsIndicator);
  }

  protected static boolean containsIndicator(String line)
  {
    return line.contains(INDICATOR);
  }
}
